// Copyright (c) 2019 An Idiot's Guide. All rights reserved. MIT license.
// https://github.com/NotAWeebDev/Misaki

const Command = require("../../base/Command.js");
const { RichEmbed } = require("discord.js");
const { stripIndents } = require("common-tags");
const snekfetch = require("snekfetch");
const h = new (require("html-entities").AllHtmlEntities)();

class Trivia extends Command {
  constructor(client) {
    super(client, {
      name: "trivia",
      description: "Puts your general knowledge to the test.",
      category: "Fun",
      usage: "trivia [difficulty]",
      aliases: ["randomtrivia", "randomq", "testme", "quiz"]
    });
  }

  async run(message, args, level) { // eslint-disable-line no-unused-vars
      const levels = ["easy", "medium", "hard"];
      const difficulty = args[0] || "medium";
      if (!levels.includes(difficulty.toLowerCase())) return message.channel.send("Invalid difficulty specified. Please choose from one of **easy**, **medium** or **hard**.");

      const { body } = await snekfetch.get(`https://opentdb.com/api.php?amount=50&difficulty=${difficulty.toLowerCase()}&type=multiple`);
      const quiz = body.results.random();
      const choices = quiz.incorrect_answers.map(ans => h.decode(ans));
      choices.push(h.decode(quiz.correct_answer));

      const randomChoices = new Array(4);
      for (let i = 0; i < 4; i++) {
          randomChoices[i] = choices.random();
          choices.splice(choices.indexOf(randomChoices[i]), 1);
      }

      const embed = new RichEmbed()
        .setColor(5360873)
        .setAuthor("Trivia", "https://vgy.me/9UDUk0.png")
        .setDescription(stripIndents`
        **Question**
        ${h.decode(quiz.question)}

        :regional_indicator_a: ${randomChoices[0]}
        :regional_indicator_b: ${randomChoices[1]}
        :regional_indicator_c: ${randomChoices[2]}
        :regional_indicator_d: ${randomChoices[3]}

        **Category & Difficulty**
        ${h.decode(quiz.category)} | ${h.decode(quiz.difficulty.toProperCase())}
        `)
        .setFooter("Reply with the correct letter within 60 seconds!", message.author.displayAvatarURL);

        const question = await this.client.awaitEmbedReply(message, "", m => m.author.id === message.author.id, 60000, {embed: embed});
        if (!question) return message.channel.send("**Trivia session ended**\nThe session timed out as you did not answer within 60 seconds.");

        const choice = randomChoices[["a", "b", "c", "d"].indexOf(question.toLowerCase())];
        if (!choice) return message.channel.send("That's not a valid answer!\nFor future reference, please ensure your answer is either **A**, **B**, **C**, or **D** (lowercase and uppercase are both accepted).");
        if (choice === h.decode(quiz.correct_answer)) return message.channel.send("Well done, your answer is correct!\nTrivia session ended.");
        else return message.channel.send(`Unfortunately, that's the wrong answer. The correct answer was **${h.decode(quiz.correct_answer)}**, and you chose **${choice}**.\nTrivia session ended.`);
  }
}

module.exports = Trivia;
